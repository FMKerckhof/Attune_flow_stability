---
title: "Attune flow stability comparison"
author: "F.M. Kerckhof, Tara Baele & Ruben Props"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    code_folding: hide
    highlight: haddock
    theme: cerulean
    fig_caption: yes
    keep_md: yes
    number_sections: yes
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: yes
      toc_dept: 3
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# Knitr options ----------------------------------------------------------------
knitr::opts_chunk$set(eval = TRUE, 
                      echo = TRUE, 
                      cache = TRUE, 
                      include = TRUE, 
                      collapse = FALSE, 
                      dependson = NULL, 
                      engine = "R", # Chunks will always have R code, unless noted
                      error = TRUE,
                      fig.path="Figures/cached/",  # Set the figure options
                      fig.align = "center"
                      )

# Load required packages -------------------------------------------------------
#library(Phenoflow)
library(flowAI)    # automated 
library(flowCore)  # handle FCS files
library(readxl)    # read from excel
library(openxlsx)  # write to excel
# load flowSets ----------------------------------------------------------------
attuneYGbeads <- flowCore::read.flowSet(path="Data/Attune_BRXX/1um_YG_dils/",
                                        pattern = "*.fcs",emptyValue = FALSE)
VerseYGbeads  <- flowCore::read.flowSet(path="Data/FACSVerse/1um_YG_beads/",
                                        pattern = "*.fcs",emptyValue = FALSE)

attune8peak <- flowCore::read.flowSet(path="Data/Attune_BRXX/8PeakDils/",
                                        pattern = "*.fcs",emptyValue = FALSE)
Verse8peak  <- flowCore::read.flowSet(path="Data/FACSVerse/8peak/",
                                        pattern = "*.fcs",emptyValue = FALSE)

attuneTruCount <- flowCore::read.flowSet(path="Data/Attune_BRXX/TruCountDils/",
                                        pattern = "*.fcs",emptyValue = FALSE)
VerseTruCount  <- flowCore::read.flowSet(path="Data/FACSVerse/TruCountDilutions/",
                                        pattern = "*.fcs",emptyValue = FALSE)

attuneRamVib <- flowCore::read.flowSet(path="Data/Attune_BRXX/RamilbacterVibrio/",
                                        pattern = "*.fcs",emptyValue = FALSE)
VerseRamVib  <- flowCore::read.flowSet(path="Data/FACSVerse/VibrioRamilbacter/",
                                        pattern = "*.fcs",emptyValue = FALSE)

attuneTWPBS <- flowCore::read.flowSet(path="Data/Attune_BRXX/Tapwater_PBSMedium/",
                                        pattern = "*.fcs",emptyValue = FALSE)
VerseTWPBS  <- flowCore::read.flowSet(path="Data/FACSVerse/Tapwater_PBSMedium/",
                                        pattern = "*.fcs",emptyValue = FALSE)

attuneTWEV <- flowCore::read.flowSet(path="Data/Attune_BRXX/Tapwater_EvianMedium/",
                                        pattern = "*.fcs",emptyValue = FALSE)
VerseTWEV  <- flowCore::read.flowSet(path="Data/FACSVerse/Tapwater_EvianMedium/",
                                        pattern = "*.fcs",emptyValue = FALSE)

# create metadata template -----------------------------------------------------
attuneYGnames <- sampleNames(attuneYGbeads)
attuneYGevs   <- fsApply(attuneYGbeads,function(x)nrow(x))
attuneYGdf    <- data.frame(Filename=attuneYGnames,Events=attuneYGevs)

FACSVerseYGnames <- sampleNames(VerseYGbeads)
FACSVerseYGevs   <- fsApply(VerseYGbeads,function(x)nrow(x))
FACSVerseYGdf    <- data.frame(Filename=FACSVerseYGnames,Events=FACSVerseYGevs)

attune8pknames <- sampleNames(attune8peak)
attune8pkevs   <- fsApply(attune8peak,function(x)nrow(x))
attune8pkdf    <- data.frame(Filename=attune8pknames,Events=attune8pkevs)

FACSVerse8pknames <- sampleNames(Verse8peak)
FACSVerse8pkevs   <- fsApply(Verse8peak,function(x)nrow(x))
FACSVerse8pkdf    <- data.frame(Filename=FACSVerse8pknames,
                                Events=FACSVerse8pkevs)

attuneTCknames <- sampleNames(attuneTruCount)
attuneTCkevs   <- fsApply(attuneTruCount,function(x)nrow(x))
attuneTCkdf    <- data.frame(Filename=attuneTCknames,Events=attuneTCkevs)

FACSVerseTCknames <- sampleNames(VerseTruCount)
FACSVerseTCkevs   <- fsApply(VerseTruCount,function(x)nrow(x))
FACSVerseTCkdf    <- data.frame(Filename=FACSVerseTCknames,
                                Events=FACSVerseTCkevs)

attuneRamVibnames <- sampleNames(attuneRamVib)
attuneRamVibevs   <- fsApply(attuneRamVib,function(x)nrow(x))
attuneRamVibdf    <- data.frame(Filename=attuneRamVibnames,
                                Events=attuneRamVibevs)

FACSVerseRamVibnames <- sampleNames(VerseRamVib)
FACSVerseRamVibevs   <- fsApply(VerseRamVib,function(x)nrow(x))
FACSVerseRamVibdf    <- data.frame(Filename=FACSVerseRamVibnames,
                                   Events=FACSVerseRamVibevs)

attuneTWPBSnames <- sampleNames(attuneTWPBS)
attuneTWPBSevs   <- fsApply(attuneTWPBS,function(x)nrow(x))
attuneTWPBSdf    <- data.frame(Filename=attuneTWPBSnames,Events=attuneTWPBSevs)

FACSVerseTWPBSnames <- sampleNames(VerseTWPBS)
FACSVerseTWPBSevs   <- fsApply(VerseTWPBS,function(x)nrow(x))
FACSVerseTWPBSdf    <- data.frame(Filename=FACSVerseTWPBSnames,
                                   Events=FACSVerseTWPBSevs)

attuneTWEVnames <- sampleNames(attuneTWEV)
attuneTWEVevs   <- fsApply(attuneTWEV,function(x)nrow(x))
attuneTWEVdf    <- data.frame(Filename=attuneTWEVnames,Events=attuneTWEVevs)

FACSVerseTWEVnames <- sampleNames(VerseTWEV)
FACSVerseTWEVevs   <- fsApply(VerseTWEV,function(x)nrow(x))
FACSVerseTWEVdf    <- data.frame(Filename=FACSVerseTWEVnames,
                                   Events=FACSVerseTWEVevs)

# write out metadata template
openxlsx::write.xlsx(list(AttuneYG=attuneYGdf,FACSVerseYG=FACSVerseYGdf,
                          Attune8pk=attune8pkdf,FACSVerse8pk=FACSVerse8pkdf,
                          AttuneTC=attuneTCkdf,FACSVerseTC=FACSVerseTCkdf,
                          AttuneRV=attuneRamVibdf,FACSVerseRV=FACSVerseRamVibdf,
                          AttuneTWP=attuneTWPBSdf,FACSVerseTWP=FACSVerseTWPBSdf,
                          AttuneTWE=attuneTWEVdf,FACSVerseTWE=FACSVerseTWEVdf),
                     file = "MetaData_template.xlsx")

```

# Introduction

This is an R markdown report evaluating actual code on raw FCS files obtained
from the BD FACSVerse and the Thermo Fisher Attune BRxx. The default analysis
workflow is followed. We evaluated 5 types of samples (listed below):

Sample Type  | Description
-------------|-------------------
1µm YG beads | In-plate dilution of Molecular Probes FluoSpheres Polystyrene Microspheres, 1.0μm, yellow-green fluorescent (505/515), for tracer studies (Thermo Fisher Scientific cat. F13081) in 0.20µm filtered PBS (Sigma) using a Tecan Freedom Evo liquid handling robot.
8-peak beads | In-plate dilution of 8-peak beads in 0.20µm filtered PBS (Sigma) using a Tecan Freedom Evo liquid handling robot.
TruCount dilutions | In-plate dilution of Becton-Dickinson TruCount (cat. 340334) in 0.20µm filtered PBS (Sigma) using a Tecan Freedom Evo liquid handling robot.
VibrioRamlibacter | In-plate dilution of axenic *Vibrio campbelii* in 0.20 µm-filtered instant ocean and *Ramlibacter aquaticus* in 0.20µm-filtered PBS (Sigma) using multi-channel micropipettes
Tapwater_PBSmedium | In-plate dilution of different tap-waters from the lab in 0.20µm-filtered PBS (Sigma) using multi-channel micropipettes
Tapwater_Evianmedium | In-plate dilution of different tap-waters from the lab in 0.20µm-filtered PBS (Sigma) using multi-channel micropipettes

# Materials & Methods

## Beads and diluents

## Robot setup

A fixed-tip Tecan Freedom Evo 100 robot was used for making the dilutions of the
beads. The needles were cleaned in between the bead types using mild bleach and
ethanol. The needles were pre-conditioned with the buffer, and all wells were
mixed three times before transferring serial dilutions to 200 µL final volume.

## Flow cytometer setup

### Thermo Scientific Attune NXT 2019 BRxx

A dual-laser (BR) Attune NXT equiped with the Attune NXT autosampler was calibrated
daily using performance tracking beads. All measurements were executed at a 
flowrate of 100 µL/min and the stopping criteria were set at 100 µL of processed
volume. 

### Bectond Dickinson FACSVerse 

A three-laser (BRV) FACSVerse equiped with the FACS Universal loader was calibrated
daily using FACSuite CS&T research beads. All measurements were run on medium 
flowrate (approx. 60 µL/min) with a stopping criteria of 100.000 events or 1 min
(whichever was reached first). A preview time of 20 seconds was included for
flow stabilisation in each sample. 


## Gate setup

Gates were set-up on the undiluted wells (shown below), but verified for all.
For the Attune, two flowsets were created: one without time-based cutoff, and
one with a 20 seconds filtered cutoff, for reasons of comparability with the
FACSVerse. 

### YG beads

```{r YGgating, cache=TRUE}
attuneYGbeads.trf <- transform(attuneYGbeads,`FSC-H`=asinh(`FSC-H`),
                               `SSC-H`=asinh(`SSC-H`),
                               `BL1-H`=asinh(`BL1-H`))
VerseYGbeads.trf <- transform(VerseYGbeads,`FSC-H`=asinh(`FSC-H`),
                               `SSC-H`=asinh(`SSC-H`),
                               `FITC-H`=asinh(`FITC-H`),
                               `V500-H`=asinh(`V500-H`))

rectGateAttuneTime <- rectangleGate("Time"=c(20e3L,Inf),
                                    filterId = "TimeGateAttune")

attuneYGbeads.trf.prv <- Subset(attuneYGbeads.trf,rectGateAttuneTime)


sqrcutAttuneYG <- matrix(c(8.75,8.75,14,14,3,7.5,14,3),ncol=2, nrow=4)
colnames(sqrcutAttuneYG) <- c("SSC-H","BL1-H")
polyGateAttuneYG <- polygonGate(.gate=sqrcutAttuneYG, filterId = "YG Beads")

```


# Test 1: Event removal by flowAI


# Test 2: distribution stability before and after presumed "gaps"

# Test 3: volumetric accuracy